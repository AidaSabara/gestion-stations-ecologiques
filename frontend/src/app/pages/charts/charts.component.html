<div class="container-fluid py-4">
  <!-- En-t√™te am√©lior√© -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">
        <i class="bi bi-graph-up text-primary me-2"></i>
        Tableau de Bord - Analyses
        <!-- üÜï Indicateur de qualit√© en temps r√©el -->
        <span class="water-quality-indicator water-quality-good"
              data-tooltip="Qualit√© de l'eau: Bonne"></span>
      </h1>
      <p class="text-muted mb-0">
        Surveillance en temps r√©el des param√®tres de qualit√© d'eau
        <!-- üÜï Badge de statut connexion -->
        <span class="badge bg-success ms-2">
          <i class="bi bi-wifi"></i> Connect√©
        </span>
      </p>
    </div>
    <div>
      <button class="btn btn-outline-primary" (click)="refreshData()" [disabled]="isLoading">
        <i class="bi bi-arrow-clockwise me-2"></i>
        {{ isLoading ? 'Chargement...' : 'Actualiser' }}
      </button>
      <!-- üÜï Bouton export (optionnel) -->
      <button class="btn btn-outline-secondary ms-2" title="Exporter les donn√©es">
        <i class="bi bi-download"></i>
      </button>
    </div>
  </div>

  <!-- üÜï NOUVEAU: Statistiques de traitement -->
  <div *ngIf="treatmentStats" class="row mb-4">
    <div class="col-12">
      <div class="card bg-gradient-primary text-white">
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-3 col-6 mb-3">
              <div class="h2 fw-bold">{{ treatmentStats.totalDates }}</div>
              <small>Dates analys√©es</small>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="h2 fw-bold">{{ treatmentStats.efficaciteTotale }}%</div>
              <small>Efficacit√© totale</small>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="h2 fw-bold">{{ treatmentStats.reductionDBO }}%</div>
              <small>R√©duction DBO5</small>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="h2 fw-bold">{{ treatmentStats.reductionDCO }}%</div>
              <small>R√©duction DCO</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Indicateurs avec am√©lioration visuelle -->
  <div class="row mb-4">
    <!-- üÜï Card avec bordure de statut -->
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card card-status-success card-hover h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                <i class="bi bi-droplet text-primary fs-4"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <h4 class="mb-0 fw-bold text-primary">{{ waterData.length }}</h4>
              <span class="text-muted small">√âchantillons d'eau</span>
              <!-- üÜï Trend indicator -->
              <div class="mt-1">
                <small class="text-success">
                  <i class="bi bi-arrow-up"></i> Donn√©es r√©elles
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card card-status-success card-hover h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-success bg-opacity-10 rounded-circle p-3">
                <i class="bi bi-thermometer-half text-success fs-4"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <h4 class="mb-0 fw-bold text-success">{{ getTemperatureSamplesCount() }}</h4>
              <span class="text-muted small">Mesures temp√©rature</span>
              <!-- üÜï Mini info -->
              <div class="mt-1">
                <small class="text-muted">üìà Station Sanar</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card card-status-warning card-hover h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                <i class="bi bi-activity text-warning fs-4"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <h4 class="mb-0 fw-bold text-warning">{{ getActiveChartsCount() }}</h4>
              <span class="text-muted small">Graphiques actifs</span>
              <!-- üÜï Ajout tooltips -->
              <div class="mt-1">
                <small class="text-muted custom-tooltip"
                       data-tooltip="Temp√©rature, Coliformes, Multi-param√®tres">
                  <i class="bi bi-info-circle"></i> D√©tails
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card card-status-success card-hover h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-info bg-opacity-10 rounded-circle p-3">
                <i class="bi bi-clock-history text-info fs-4"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <h4 class="mb-0 fw-bold text-info">{{ getLastUpdateTime() }}</h4>
              <span class="text-muted small">Derni√®re mise √† jour</span>
              <!-- üÜï Temps relatif -->
              <div class="mt-1">
                <small class="text-muted">Temps r√©el</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading state avec skeleton -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="mt-3 text-muted fs-5">Chargement des donn√©es en cours...</p>
    <div class="progress mt-3" style="height: 4px;">
      <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
    </div>
  </div>

  <!-- Graphiques principaux -->
  <div *ngIf="!isLoading && waterData.length > 0" class="row">

    <!-- üÜï NOUVEAU: Section Flux de Traitement -->
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-dark">
              <i class="bi bi-diagram-3 text-success me-2"></i>
              Flux de Traitement des Eaux - Analyse Compl√®te
            </h5>
            <div>
              <span class="badge bg-success">Entr√©e ‚Üí FV ‚Üí FH ‚Üí Sortie</span>
              <span class="badge bg-light text-dark ms-2">
                <i class="bi bi-filter"></i> Traitement multi-√©tapes
              </span>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- Graphique Flux DBO5 Principal -->
            <div class="col-12 mb-4">
              <div class="chart-container" style="height: 400px;">
                <canvas id="treatmentFlowChart"></canvas>
              </div>
              <div class="text-center mt-2">
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  Visualisation du flux complet : Entr√©e ‚Üí Filtres Verticaux (FV1, FV2) ‚Üí Filtres Horizontaux (FH) ‚Üí Sortie
                </small>
              </div>
            </div>

            <!-- Graphiques D√©tails -->
            <div class="col-xl-6 col-lg-12 mb-4">
              <div class="chart-container" style="height: 350px;">
                <canvas id="dbo5FlowChart"></canvas>
              </div>
              <div class="text-center mt-2">
                <small class="text-muted">
                  <i class="bi bi-graph-up-arrow me-1"></i>
                  D√©tail DBO5 avec indicateurs d'efficacit√©
                </small>
              </div>
            </div>

            <div class="col-xl-6 col-lg-12 mb-4">
              <div class="chart-container" style="height: 350px;">
                <canvas id="dcoFlowChart"></canvas>
              </div>
              <div class="text-center mt-2">
                <small class="text-muted">
                  <i class="bi bi-activity me-1"></i>
                  Flux de traitement DCO (Demande Chimique en Oxyg√®ne)
                </small>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer bg-light border-0 py-2">
          <div class="row">
            <div class="col-md-4">
              <small class="text-muted">
                <i class="bi bi-arrow-90deg-down text-primary me-1"></i>
                <strong>Entr√©e:</strong> Eaux brutes non trait√©es
              </small>
            </div>
            <div class="col-md-4">
              <small class="text-muted">
                <i class="bi bi-filter-circle text-info me-1"></i>
                <strong>FV:</strong> Filtres Verticaux (FV1, FV2)
              </small>
            </div>
            <div class="col-md-4">
              <small class="text-muted">
                <i class="bi bi-check-circle text-success me-1"></i>
                <strong>FH:</strong> Filtres Horizontaux (Sortie finale)
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Graphique Multi-Param√®tres (Principal) -->
    <div class="col-12 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-dark">
              <i class="bi bi-speedometer2 text-primary me-2"></i>
              √âvolution Multi-Param√®tres de la Qualit√© de l'Eau
            </h5>
            <div>
              <span class="badge bg-primary">Donn√©es r√©elles</span>
              <!-- üÜï Badge info p√©riode -->
              <span class="badge bg-light text-dark ms-2">
                <i class="bi bi-calendar-range"></i> Avril 2019
              </span>
            </div>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart-container" style="height: 400px;">
            <canvas id="multiParamChart"></canvas>
          </div>
        </div>
        <div class="card-footer bg-light border-0 py-2">
          <div class="d-flex justify-content-between align-items-center flex-wrap">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Surveillance simultan√©e du pH, DBO5, DCO et Nitrates
            </small>
            <!-- üÜï Filtres rapides (optionnel - n√©cessite logique TS) -->
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-secondary active">Tout</button>
              <button class="btn btn-outline-secondary">30J</button>
              <button class="btn btn-outline-secondary">7J</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Graphique Temp√©rature -->
    <div class="col-xl-6 col-lg-12 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 py-3">
          <h5 class="mb-0 text-dark">
            <i class="bi bi-thermometer-sun text-danger me-2"></i>
            √âvolution de la Temp√©rature
          </h5>
        </div>
        <div class="card-body p-3">
          <div class="chart-container" style="height: 300px;">
            <canvas id="temperatureChart"></canvas>
          </div>
        </div>
        <div class="card-footer bg-light border-0 py-2">
          <small class="text-muted">
            <i class="bi bi-calendar me-1"></i>
            20 derni√®res mesures avec dates r√©elles
          </small>
        </div>
      </div>
    </div>

    <!-- Graphique Coliformes dans le temps -->
    <div class="col-xl-6 col-lg-12 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 py-3">
          <h5 class="mb-0 text-dark">
            <i class="bi bi-bug-fill text-warning me-2"></i>
            √âvolution des Coliformes F√©caux
          </h5>
        </div>
        <div class="card-body p-3">
          <div class="chart-container" style="height: 300px;">
            <canvas id="coliformesChart"></canvas>
          </div>
        </div>
        <div class="card-footer bg-light border-0 py-2">
          <div class="row">
            <div class="col">
              <small class="text-muted">
                <i class="bi bi-exclamation-triangle me-1"></i>
                Seuil recommand√©: 100 CFU/100ml
              </small>
            </div>
            <div class="col-auto">
              <small class="text-muted">
                20 derni√®res mesures
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- üÜï NOUVEAU: Alertes en temps r√©el (conditionnel) -->
  <div *ngIf="!isLoading && waterData.length > 0" class="row mb-4">
    <div class="col-12">
      <div class="card border-warning">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle text-warning fs-4 me-3 alert-pulse"></i>
            <div class="flex-grow-1">
              <h6 class="mb-1">‚ö†Ô∏è Alerte: Coliformes √©lev√©s d√©tect√©s</h6>
              <small class="text-muted">
                Niveau d√©tect√©: 2,670,000 CFU/100ml - Station Sanar - 09/04/2019
              </small>
            </div>
            <button class="btn btn-sm btn-outline-warning">Voir d√©tails</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- √âtat vide -->
  <div *ngIf="!isLoading && waterData.length === 0" class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
          <div class="mb-4">
            <i class="bi bi-graph-down text-muted" style="font-size: 4rem;"></i>
          </div>
          <h3 class="text-muted mb-3">Aucune donn√©e disponible</h3>
          <p class="text-muted mb-4">
            Les donn√©es de surveillance n'ont pas pu √™tre charg√©es.<br>
            V√©rifiez la connexion aux capteurs et r√©essayez.
          </p>
          <button class="btn btn-primary btn-lg" (click)="refreshData()">
            <i class="bi bi-arrow-clockwise me-2"></i>
            R√©essayer le chargement
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- L√©gende des param√®tres am√©lior√©e -->
  <div *ngIf="!isLoading && waterData.length > 0" class="row mt-4">
    <div class="col-12">
      <div class="card border-0 bg-light">
        <div class="card-body py-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">
              <i class="bi bi-info-circle text-primary me-2"></i>
              Guide des Param√®tres & Seuils R√©glementaires
            </h6>
            <!-- üÜï Lien vers documentation -->
            <a href="#" class="text-decoration-none small">
              <i class="bi bi-book"></i> Documentation compl√®te
            </a>
          </div>
          <div class="row g-3">
            <div class="col-md-3 col-6">
              <div class="d-flex align-items-start">
                <div class="color-indicator bg-primary rounded me-2 mt-1"
                     style="width: 16px; height: 4px;"></div>
                <div>
                  <small class="text-muted">
                    <strong>pH:</strong> Potentiel Hydrog√®ne
                  </small>
                  <!-- üÜï Valeurs normales -->
                  <div>
                    <small class="text-success">‚úì Normal: 6.5-8.5</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="d-flex align-items-start">
                <div class="color-indicator bg-danger rounded me-2 mt-1"
                     style="width: 16px; height: 4px;"></div>
                <div>
                  <small class="text-muted">
                    <strong>DBO5:</strong> Demande Biologique en O‚ÇÇ
                  </small>
                  <div>
                    <small class="text-success">‚úì Normal: &lt;25 mg/L</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="d-flex align-items-start">
                <div class="color-indicator bg-warning rounded me-2 mt-1"
                     style="width: 16px; height: 4px;"></div>
                <div>
                  <small class="text-muted">
                    <strong>DCO:</strong> Demande Chimique en O‚ÇÇ
                  </small>
                  <div>
                    <small class="text-success">‚úì Normal: &lt;125 mg/L</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="d-flex align-items-start">
                <div class="color-indicator bg-info rounded me-2 mt-1"
                     style="width: 16px; height: 4px;"></div>
                <div>
                  <small class="text-muted">
                    <strong>Nitrates:</strong> Concentration
                  </small>
                  <div>
                    <small class="text-success">‚úì Normal: &lt;50 mg/L</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
